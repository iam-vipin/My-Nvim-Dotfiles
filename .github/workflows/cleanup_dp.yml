name: Cleanup Closed PRs

on:
  workflow_dispatch:
  schedule:
    - cron: 0 0 * * *

jobs:
  execute:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: read    
    steps:
      # Checkout the code
      - uses: actions/checkout@v2

      - name: Configure AWS credentials to assume the EKS role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_EKS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region ${{ secrets.AWS_REGION || 'us-east-1' }} \
            --name ${{ secrets.EKS_CLUSTER_NAME || 'plane-eks-dev'}}

      - name: Verify access
        run: |
          kubectl get nodes
    
      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
            version: v3.14.4
  
      - name: Verify Helm
        run: |
          helm version

      - name: Cleanup merged or closed PR deployments
        run: |
          set -e
          # Match release names ee-<PR>-ent or ee-<PR>-cloud (e.g. ee-5657-ent, ee-5657-cloud)
          deployed_charts="$(helm ls -A --filter 'ee-[0-9]+-(ent|cloud)' --output json | jq -r '.[].name')"
          for deployed_chart in $deployed_charts; do
            namespace="$deployed_chart"
            pr=$(echo "$deployed_chart" | sed -n 's/^ee-\([0-9]*\)-.*/\1/p');
            pr_state="$(gh pr view "$pr" --json state --jq .state)"
            if [[ $pr_state == "MERGED" || $pr_state == "CLOSED" ]]; then
              echo "PR $pr is merged or closed, cleaning up $namespace"
              helm uninstall $deployed_chart --namespace $deployed_chart || true
              # Find PVs bound to PVCs in this namespace (works for ee-5657-ent, ee-5657-cloud, or legacy ee-5657)
              pv_list=$(kubectl get pv -o json 2>/dev/null | jq -r --arg ns "$namespace" '.items[] | select(.spec.claimRef.namespace == $ns) | .metadata.name' 2>/dev/null) || true
              for pv in $pv_list; do
                echo "Removing PV $pv (was bound to namespace $namespace)"
                kubectl patch pv "$pv" -p '{"metadata":{"finalizers":null}}' --type=merge 2>/dev/null || true
                kubectl delete pv "$pv" --grace-period=0 --force 2>/dev/null || true
              done
              # Remove namespace finalizers if stuck, then delete namespace
              kubectl patch ns "$namespace" -p '{"metadata":{"finalizers":null}}' --type=merge 2>/dev/null || true
              kubectl delete ns "$namespace" --grace-period=0 --force 2>/dev/null || true
            fi
          done
          echo "Merged or closed PR deployments cleaned up"
