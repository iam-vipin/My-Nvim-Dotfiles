name: Deploy PR on demand

on:
    # This workflow is only triggered by the `/deploy` command dispatch
    repository_dispatch:
      types: [deploy-command]

jobs:
  pre-requisites:
    runs-on: ubuntu-latest
    outputs:
      release_version: ${{ steps.set_env_variables.outputs.RELEASE_VERSION }}
      image_repo: ${{ steps.set_env_variables.outputs.IMAGE_REPO }}
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Guidelines
        uses: peter-evans/create-or-update-comment@v3
        with:
          token: ${{ secrets.PAT }}
          issue-number: ${{ github.event.client_payload.pull_request.number }}
          body: |
            ## Deploy PR Guidelines
            Please fix merge conflicts IF ANY before using the deploy-pr command.
            If you need any new environment variables you need to release preview helm chart first.
          comment-id: deploy-pr-guidelines

      - name: Add a comment on the PR with link to workflow run
        uses: peter-evans/create-or-update-comment@v3
        with:
          token: ${{ secrets.PAT }}
          issue-number: ${{ github.event.client_payload.pull_request.number }}
          body: |
            Deploying Your PR: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}>.
            type: ${{ github.event.client_payload.slash_command.args.named.type }}
            airgap: ${{ github.event.client_payload.slash_command.args.named.airgap }}
            aio: ${{ github.event.client_payload.slash_command.args.named.aio }}
            identifier: ee-${{ github.event.client_payload.pull_request.number }}
            helm_repo: ${{ github.event.client_payload.slash_command.args.named.helm_repo }}

      - name: Set Environment Variables
        id: set_env_variables
        run: |
            echo "RELEASE_VERSION=ee-${{ github.event.client_payload.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "BUILDX_DRIVER=docker-container" >> $GITHUB_OUTPUT
            echo "BUILDX_VERSION=latest" >> $GITHUB_OUTPUT
            echo "BUILDX_PLATFORMS=linux/amd64" >> $GITHUB_OUTPUT
            echo "BUILDX_ENDPOINT=" >> $GITHUB_OUTPUT
            if [ "${{ github.event.client_payload.slash_command.args.named.type }}" == "enterprise" ]; then
              echo "IMAGE_REPO=commercial" >> $GITHUB_OUTPUT
            else
              echo "IMAGE_REPO=cloud" >> $GITHUB_OUTPUT
            fi
      - name: Print PR number
        run: |
            echo "PR number: ${{ github.event.client_payload.pull_request.number }}"

  branch_build_push_admin:
    name: Build-Push Admin Docker Image
    needs: [pre-requisites]
    runs-on: ubuntu-22.04
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.client_payload.pull_request.number }}/merge
      - name: Get commit short hash
        id: get_commit_short_hash
        run: |
          echo "COMMIT_SHORT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          push: true
          context: .
          file: ./apps/admin/Dockerfile.admin
          tags: |
            makeplane/plane-admin-${{ needs.pre-requisites.outputs.image_repo }}:${{ needs.pre-requisites.outputs.release_version }}
            makeplane/plane-admin-${{ needs.pre-requisites.outputs.image_repo }}:${{ steps.get_commit_short_hash.outputs.COMMIT_SHORT_HASH }}

  branch_build_push_silo:
    name: Build-Push Silo Docker Image
    needs: [pre-requisites]
    runs-on: ubuntu-22.04
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.client_payload.pull_request.number }}/merge
      - name: Get commit short hash
        id: get_commit_short_hash
        run: |
          echo "COMMIT_SHORT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          push: true
          context: .
          file: ./apps/silo/Dockerfile.silo
          tags: |
            makeplane/plane-silo-${{ needs.pre-requisites.outputs.image_repo }}:${{ needs.pre-requisites.outputs.release_version }}
            makeplane/plane-silo-${{ needs.pre-requisites.outputs.image_repo }}:${{ steps.get_commit_short_hash.outputs.COMMIT_SHORT_HASH }}

  branch_build_push_web:
    name: Build-Push Web Docker Image
    runs-on: ubuntu-22.04
    needs: [pre-requisites]
    permissions:
        id-token: write
        contents: read
    steps:
        - name: Checkout Code
          uses: actions/checkout@v4
          with:
            ref: refs/pull/${{ github.event.client_payload.pull_request.number }}/merge
        - name: Get commit short hash
          id: get_commit_short_hash
          run: |
            echo "COMMIT_SHORT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        - name: Login to Docker Hub
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_TOKEN }}
        - name: Set up QEMU
          uses: docker/setup-qemu-action@v3
        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3
        - name: Build and push
          uses: docker/build-push-action@v6
          with:
            push: true
            context: .
            file: ./apps/web/Dockerfile.web
            tags: |
              makeplane/plane-web-${{ needs.pre-requisites.outputs.image_repo }}:${{ needs.pre-requisites.outputs.release_version }}
              makeplane/plane-web-${{ needs.pre-requisites.outputs.image_repo }}:${{ steps.get_commit_short_hash.outputs.COMMIT_SHORT_HASH }}

  branch_build_push_space:
    name: Build-Push Space Docker Image
    runs-on: ubuntu-22.04
    needs: [pre-requisites]
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.client_payload.pull_request.number }}/merge
      - name: Get commit short hash
        id: get_commit_short_hash
        run: |
          echo "COMMIT_SHORT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          push: true
          context: .
          file: ./apps/space/Dockerfile.space
          tags: |
            makeplane/plane-space-${{ needs.pre-requisites.outputs.image_repo }}:${{ needs.pre-requisites.outputs.release_version }}
            makeplane/plane-space-${{ needs.pre-requisites.outputs.image_repo }}:${{ steps.get_commit_short_hash.outputs.COMMIT_SHORT_HASH }}

  branch_build_push_live:
    name: Build-Push Live Collaboration Docker Image
    runs-on: ubuntu-22.04
    needs: [pre-requisites]
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.client_payload.pull_request.number }}/merge
      - name: Get commit short hash
        id: get_commit_short_hash
        run: |
          echo "COMMIT_SHORT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          push: true
          context: .
          file: ./apps/live/Dockerfile.live
          tags: |
            makeplane/plane-live-${{ needs.pre-requisites.outputs.image_repo }}:${{ needs.pre-requisites.outputs.release_version }}
            makeplane/plane-live-${{ needs.pre-requisites.outputs.image_repo }}:${{ steps.get_commit_short_hash.outputs.COMMIT_SHORT_HASH }}

  branch_build_push_api:
    name: Build-Push API Server Docker Image
    runs-on: ubuntu-22.04
    needs: [pre-requisites]
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.client_payload.pull_request.number }}/merge
      - name: Get commit short hash
        id: get_commit_short_hash
        run: |
          echo "COMMIT_SHORT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          push: true
          context: ./apps/api
          file: ./apps/api/Dockerfile.api
          tags: |
            makeplane/plane-backend-${{ needs.pre-requisites.outputs.image_repo }}:${{ needs.pre-requisites.outputs.release_version }}
            makeplane/plane-backend-${{ needs.pre-requisites.outputs.image_repo }}:${{ steps.get_commit_short_hash.outputs.COMMIT_SHORT_HASH }}

  branch_build_push_proxy:
    name: Build-Push Proxy Docker Image
    runs-on: ubuntu-22.04
    needs: [pre-requisites]
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.client_payload.pull_request.number }}/merge
      - name: Get commit short hash
        id: get_commit_short_hash
        run: |
          echo "COMMIT_SHORT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          push: true
          context: ./apps/proxy
          file: ./apps/proxy/Dockerfile.ce
          tags: |
            makeplane/plane-proxy-${{ needs.pre-requisites.outputs.image_repo }}:${{ needs.pre-requisites.outputs.release_version }}
            makeplane/plane-proxy-${{ needs.pre-requisites.outputs.image_repo }}:${{ steps.get_commit_short_hash.outputs.COMMIT_SHORT_HASH }}

  branch_build_push_aio:
    name: Build-Push AIO Docker Image
    if: ${{ github.event.client_payload.slash_command.args.named.aio == 'true' }}
    runs-on: ubuntu-22.04
    needs:
      - pre-requisites
      - branch_build_push_admin
      - branch_build_push_web
      - branch_build_push_space
      - branch_build_push_live
      - branch_build_push_api
      - branch_build_push_proxy
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.client_payload.pull_request.number }}/merge
      - name: Get commit short hash
        id: get_commit_short_hash
        run: |
          echo "COMMIT_SHORT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Prepare AIO Assets
        id: prepare_aio_assets
        run: |
          cd deployments/aio/community

          aio_version=${{ needs.pre-requisites.outputs.release_version }}
          bash ./build.sh --release $aio_version
          echo "AIO_BUILD_VERSION=${aio_version}" >> $GITHUB_OUTPUT

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          push: true
          context: ./deployments/aio/community
          file: ./deployments/aio/community/Dockerfile
          tags: |
            makeplane/plane-aio-${{ needs.pre-requisites.outputs.image_repo }}:${{ needs.pre-requisites.outputs.release_version }}
            makeplane/plane-aio-${{ needs.pre-requisites.outputs.image_repo }}:${{ steps.get_commit_short_hash.outputs.COMMIT_SHORT_HASH }}
          build-args: |
            PLANE_VERSION=${{ steps.prepare_aio_assets.outputs.AIO_BUILD_VERSION }}

  deploy-plane:
    name: Deploy plane
    needs: [pre-requisites,
      branch_build_push_admin,
      branch_build_push_web,
      branch_build_push_space,
      branch_build_push_live,
      branch_build_push_api,
      branch_build_push_proxy
    ]
    runs-on: ubuntu-22.04
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    steps:
      - name: Configure AWS credentials to assume the secret role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_SECRET_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Retrieve deploy secrets from AWS Secrets Manager
        id: deploy-secrets
        run: |
          SECRET_JSON=$(aws secretsmanager get-secret-value --secret-id ${{ secrets.AWS_SECRET_NAME || 'github-actions/github-actions-secrets' }} --query SecretString --output text)
          CLOUDFLARE_TOKEN=$(echo $SECRET_JSON | jq -r '.cloudflare_api_token')
          echo "cloudflare_token=$CLOUDFLARE_TOKEN" >> $GITHUB_ENV
          echo "::add-mask::$CLOUDFLARE_TOKEN"

      - name: Configure AWS credentials to assume the EKS role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_EKS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region ${{ secrets.AWS_REGION || 'us-east-1' }} \
            --name ${{ secrets.EKS_CLUSTER_NAME || 'plane-eks-dev'}}

      - name: Verify access
        run: |
          kubectl get nodes

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Verify Helm
        run: |
          helm version

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.client_payload.pull_request.number }}/merge

      - name: Decide the type of helm chart to deploy
        id: decide_chart
        run: |
          if [ "${{ github.event.client_payload.slash_command.args.named.type }}" == "enterprise" ]; then
            HELM_CHART="plane-enterprise"
          else
            HELM_CHART="plane-cloud"
          fi
          echo "HELM_CHART=${HELM_CHART}" >> $GITHUB_OUTPUT
          echo "Using helm chart: ${HELM_CHART}"

      - name: Add helm chart repository
        run: |
          HELM_REPO="${{ github.event.client_payload.slash_command.args.named.helm_repo }}"
          if [ "${{ github.event.client_payload.slash_command.args.named.type }}" == "enterprise" ]; then
            REPO_NAME="plane-enterprise"
            DEFAULT_URL="https://helm.plane.so"
          else
            REPO_NAME="plane-cloud"
            DEFAULT_URL="https://private-helm.plane.tools"
          fi
          helm repo add "$REPO_NAME" "${HELM_REPO:-$DEFAULT_URL}"
          helm repo update

      - name: Deploy using helm with custom values
        run: |
          RELEASE_NAME="${{ needs.pre-requisites.outputs.release_version }}"
          PR_NUMBER="${{ github.event.client_payload.pull_request.number }}"
          DEPLOY_TYPE="${{ github.event.client_payload.slash_command.args.named.type }}"
          IMAGE_TAG="${{ needs.pre-requisites.outputs.release_version }}"
          GOLDENSET="./deployments/local_deployments/goldenset_${DEPLOY_TYPE}.yml"

          if [ "${DEPLOY_TYPE}" == "enterprise" ]; then
            CHART_REF="plane-enterprise/plane-enterprise"
          else
            CHART_REF="plane-cloud/plane-cloud"
          fi

          if [ -z "${RELEASE_NAME}" ] || [ -z "${CHART_REF}" ]; then
            echo "::error::RELEASE_NAME or CHART_REF is empty. RELEASE_NAME='${RELEASE_NAME}' CHART_REF='${CHART_REF}'"
            exit 1
          fi

          echo "Deploying release=${RELEASE_NAME} chart=${CHART_REF} namespace=${NAMESPACE}"

          if [ "${DEPLOY_TYPE}" == "enterprise" ]; then
            RELEASE_NAME="${RELEASE_NAME}-ent"
            APP_HOST="feat-${PR_NUMBER}-ee.feat.plane.town"
            NAMESPACE="${RELEASE_NAME}"
            helm upgrade --install "${RELEASE_NAME}" "${CHART_REF}" \
              --namespace ${NAMESPACE} \
              --create-namespace \
              --set dockerRegistry.loginid=${{ secrets.DOCKERHUB_USERNAME }} \
              --set dockerRegistry.password=${{ secrets.DOCKERHUB_TOKEN }} \
              --set dockerRegistry.enabled=true \
              --set services.api.image=makeplane/plane-backend-${{ needs.pre-requisites.outputs.image_repo }} \
              --set services.silo.image=makeplane/plane-silo-${{ needs.pre-requisites.outputs.image_repo }} \
              --set services.web.image=makeplane/plane-web-${{ needs.pre-requisites.outputs.image_repo }} \
              --set services.space.image=makeplane/plane-space-${{ needs.pre-requisites.outputs.image_repo }} \
              --set services.live.image=makeplane/plane-live-${{ needs.pre-requisites.outputs.image_repo }} \
              --set services.admin.image=makeplane/plane-admin-${{ needs.pre-requisites.outputs.image_repo }} \
              --set services.proxy.image=makeplane/plane-proxy-${{ needs.pre-requisites.outputs.image_repo }} \
              --set planeVersion=${IMAGE_TAG} \
              --set ingress.enabled=true \
              --set license.licenseDomain=${APP_HOST} \
              --set env.web_url=https://${APP_HOST} \
              --set ssl.createIssuer=true \
              --set ssl.issuer=cloudflare \
              --set ssl.token=${{ env.cloudflare_token }} \
              --set ssl.email=engineering@plane.so \
              --set ssl.generateCerts=true \
              --set env.storageClass=gp2 \
              --values ${GOLDENSET}
          else
            RELEASE_NAME="${RELEASE_NAME}-cloud"
            APP_HOST="feat-${PR_NUMBER}-cloud.feat.plane.town"
            NAMESPACE="${RELEASE_NAME}"
            helm upgrade --install "${RELEASE_NAME}" "${CHART_REF}" \
              --namespace ${NAMESPACE} \
              --create-namespace \
              --set dockerhub.login_id=${{ secrets.DOCKERHUB_USERNAME }} \
              --set dockerhub.password=${{ secrets.DOCKERHUB_TOKEN }} \
              --set docker.enabled=true \
              --set ingress.app_host=${APP_HOST} \
              --set ssl.create_issuer=true \
              --set ssl.issuer=cloudflare \
              --set ssl.token=${{ env.cloudflare_token }} \
              --set ssl.email=engineering@plane.so \
              --set ssl.generate_certs=true \
              --set services.storage_class=gp2 \
              --set services.web.enabled=true \
              --set services.web.image=makeplane/plane-web-${{ needs.pre-requisites.outputs.image_repo }} \
              --set services.space.enabled=true \
              --set services.space.image=makeplane/plane-space-${{ needs.pre-requisites.outputs.image_repo }} \
              --set services.admin.enabled=true \
              --set services.admin.image=makeplane/plane-admin-${{ needs.pre-requisites.outputs.image_repo }} \
              --set services.api.enabled=true \
              --set services.api.image=makeplane/plane-backend-${{ needs.pre-requisites.outputs.image_repo }} \
              --set services.proxy.enabled=true \
              --set services.proxy.image=makeplane/plane-proxy-${{ needs.pre-requisites.outputs.image_repo }} \
              --set services.live.enabled=true \
              --set services.live.image=makeplane/plane-live-${{ needs.pre-requisites.outputs.image_repo }} \
              --set services.silo.enabled=true \
              --set services.silo.image=makeplane/plane-silo-${{ needs.pre-requisites.outputs.image_repo }} \
              --set services.pi.enabled=false \
              --set services.marketplace.enabled=false \
              --set services.auth.enabled=false \
              --set services.external_api.enabled=false \
              --set services.email_service.enabled=false \
              --set services.pi_worker.enabled=false \
              --set services.pi_beat_worker.enabled=false \
              --set django_backend.session_cookie_domain=.plane.town \
              --set opensearch.enabled=false \
              --set planeVersion=${IMAGE_TAG} \
              --values ${GOLDENSET}
          fi

      - name: Comment URL to access plane deployment
        uses: peter-evans/create-or-update-comment@v3
        with:
          token: ${{ secrets.PAT }}
          issue-number: ${{ github.event.client_payload.pull_request.number }}
          body: |
            Plane deployment will be available at https://feat-${{ github.event.client_payload.pull_request.number }}-${{ (github.event.client_payload.slash_command.args.named.type == 'enterprise' && 'ee') || 'cloud' }}.feat.plane.town in few minutes.
          comment-id: deploy-plane-url