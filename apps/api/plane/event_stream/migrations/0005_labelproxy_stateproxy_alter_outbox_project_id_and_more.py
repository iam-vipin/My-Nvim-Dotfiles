# Generated by Django 4.2.27 on 2026-01-30 13:14

from django.db import migrations, models
import pgtrigger.compiler
import pgtrigger.migrations


class Migration(migrations.Migration):

    dependencies = [
        ('db', '0118_remove_workspaceuserproperties_product_tour_and_more'),
        ('event_stream', '0004_remove_cycleissueproxy_cycle_issue_outbox_insert_and_more'),
    ]

    operations = [
        migrations.CreateModel(
            name='LabelProxy',
            fields=[
            ],
            options={
                'proxy': True,
                'indexes': [],
                'constraints': [],
            },
            bases=('db.label',),
        ),
        migrations.CreateModel(
            name='StateProxy',
            fields=[
            ],
            options={
                'proxy': True,
                'indexes': [],
                'constraints': [],
            },
            bases=('db.state',),
        ),
        migrations.AlterField(
            model_name='outbox',
            name='project_id',
            field=models.UUIDField(blank=True, null=True),
        ),
        pgtrigger.migrations.AddTrigger(
            model_name='labelproxy',
            trigger=pgtrigger.compiler.Trigger(name='label_outbox_insert', sql=pgtrigger.compiler.UpsertTriggerSql(func="\n                DECLARE\n                    label_data JSONB;\n                BEGIN\n                    -- Create label data\n                    label_data := to_jsonb(NEW);\n\n                    BEGIN\n                        INSERT INTO outbox (event_id, event_type, entity_type, entity_id, workspace_id, project_id, payload, created_at, initiator_id, initiator_type)\n                        VALUES (\n                            gen_random_uuid(),\n                            'label.created',\n                            'label',\n                            NEW.id,\n                            NEW.workspace_id,\n                            NEW.project_id,\n                            jsonb_build_object(\n                                'data', label_data,\n                                'previous_attributes', '{}'\n                            ),\n                            now(),\n                            NEW.created_by_id,\n                            COALESCE(current_setting('plane.initiator_type', true), 'USER')\n                        )\n                        ON CONFLICT DO NOTHING;\n                    EXCEPTION\n                        WHEN others THEN\n                            RAISE WARNING 'Outbox insert failed for label %, reason: %',\n                                         NEW.id, SQLERRM;\n                    END;\n                    RETURN NEW;\n                END;\n                ", hash='bee1745c5ac5d308cb274ac7a88ba6f963813174', operation='INSERT', pgid='pgtrigger_label_outbox_insert_97b5a', table='labels', when='AFTER')),
        ),
        pgtrigger.migrations.AddTrigger(
            model_name='labelproxy',
            trigger=pgtrigger.compiler.Trigger(name='label_outbox_update', sql=pgtrigger.compiler.UpsertTriggerSql(func="\n                DECLARE\n                    changes JSONB := '{}';\n                    field_name TEXT;\n                    old_value TEXT;\n                    new_value TEXT;\n                    label_data JSONB;\n                    has_changes BOOLEAN := false;\n                BEGIN\n                    -- Check if this is a soft delete (deleted_at changed from null to not null)\n                    IF OLD.deleted_at IS NULL AND NEW.deleted_at IS NOT NULL THEN\n                        -- This is a soft delete\n                        label_data := to_jsonb(OLD);\n\n                        BEGIN\n                            INSERT INTO outbox (event_id, event_type, entity_type, entity_id, workspace_id, project_id, payload, created_at, initiator_id, initiator_type)\n                            VALUES (\n                                gen_random_uuid(),\n                                'label.deleted',\n                                'label',\n                                OLD.id,\n                                OLD.workspace_id,\n                                OLD.project_id,\n                                jsonb_build_object('data', '{}', 'previous_attributes', label_data),\n                                now(),\n                                NEW.updated_by_id,\n                                COALESCE(current_setting('plane.initiator_type', true), 'USER')\n                            )\n                            ON CONFLICT DO NOTHING;\n                        EXCEPTION\n                            WHEN others THEN\n                                RAISE WARNING 'Outbox delete failed for label %, reason: %',\n                                             OLD.id, SQLERRM;\n                        END;\n                    ELSE\n                        -- This is a regular update, check for changes\n                        FOR field_name IN\n                            SELECT column_name\n                            FROM information_schema.columns\n                            WHERE table_name = 'labels'\n                            AND table_schema = 'public'\n                            AND column_name NOT IN ('updated_at', 'updated_by_id')\n                        LOOP\n                            -- Get old and new values as text to avoid JSON conversion issues\n                            EXECUTE format('SELECT ($1).%I::text, ($2).%I::text', field_name, field_name)\n                            INTO old_value, new_value\n                            USING OLD, NEW;\n\n                            -- If values are different, add to changes\n                            IF old_value IS DISTINCT FROM new_value THEN\n                                has_changes := true;\n                                changes := changes || jsonb_build_object(\n                                    field_name,\n                                    old_value\n                                );\n                            END IF;\n                        END LOOP;\n\n                        -- Only proceed if there are actual changes\n                        IF has_changes THEN\n                            label_data := to_jsonb(NEW);\n\n                            BEGIN\n                                INSERT INTO outbox (event_id, event_type, entity_type, entity_id, workspace_id, project_id, payload, created_at, initiator_id, initiator_type)\n                                VALUES (\n                                    gen_random_uuid(),\n                                    'label.updated',\n                                    'label',\n                                    NEW.id,\n                                    NEW.workspace_id,\n                                    NEW.project_id,\n                                    jsonb_build_object(\n                                        'data', label_data,\n                                        'previous_attributes', changes\n                                    ),\n                                    now(),\n                                    NEW.updated_by_id,\n                                    COALESCE(current_setting('plane.initiator_type', true), 'USER')\n                                )\n                                ON CONFLICT DO NOTHING;\n                            EXCEPTION\n                                WHEN others THEN\n                                    RAISE WARNING 'Outbox update failed for label %, reason: %',\n                                                 NEW.id, SQLERRM;\n                            END;\n                        END IF;\n                    END IF;\n\n                    RETURN NEW;\n                END;\n                ", hash='c7027564785a92ba1579b48b6e750706e7ae27db', operation='UPDATE', pgid='pgtrigger_label_outbox_update_d4a51', table='labels', when='AFTER')),
        ),
        pgtrigger.migrations.AddTrigger(
            model_name='stateproxy',
            trigger=pgtrigger.compiler.Trigger(name='state_outbox_insert', sql=pgtrigger.compiler.UpsertTriggerSql(func="\n                DECLARE\n                    state_data JSONB;\n                BEGIN\n                    -- Create state data\n                    state_data := to_jsonb(NEW);\n\n                    BEGIN\n                        INSERT INTO outbox (event_id, event_type, entity_type, entity_id, workspace_id, project_id, payload, created_at, initiator_id, initiator_type)\n                        VALUES (\n                            gen_random_uuid(),\n                            'state.created',\n                            'state',\n                            NEW.id,\n                            NEW.workspace_id,\n                            NEW.project_id,\n                            jsonb_build_object(\n                                'data', state_data,\n                                'previous_attributes', '{}'\n                            ),\n                            now(),\n                            NEW.created_by_id,\n                            COALESCE(current_setting('plane.initiator_type', true), 'USER')\n                        )\n                        ON CONFLICT DO NOTHING;\n                    EXCEPTION\n                        WHEN others THEN\n                            RAISE WARNING 'Outbox insert failed for state %, reason: %',\n                                         NEW.id, SQLERRM;\n                    END;\n                    RETURN NEW;\n                END;\n                ", hash='cd70ccc7cff9bf8e958bd7a37cb71bf3995e5288', operation='INSERT', pgid='pgtrigger_state_outbox_insert_11112', table='states', when='AFTER')),
        ),
        pgtrigger.migrations.AddTrigger(
            model_name='stateproxy',
            trigger=pgtrigger.compiler.Trigger(name='state_outbox_update', sql=pgtrigger.compiler.UpsertTriggerSql(func="\n                DECLARE\n                    changes JSONB := '{}';\n                    field_name TEXT;\n                    old_value TEXT;\n                    new_value TEXT;\n                    state_data JSONB;\n                    has_changes BOOLEAN := false;\n                BEGIN\n                    -- Check if this is a soft delete (deleted_at changed from null to not null)\n                    IF OLD.deleted_at IS NULL AND NEW.deleted_at IS NOT NULL THEN\n                        -- This is a soft delete\n                        state_data := to_jsonb(OLD);\n\n                        BEGIN\n                            INSERT INTO outbox (event_id, event_type, entity_type, entity_id, workspace_id, project_id, payload, created_at, initiator_id, initiator_type)\n                            VALUES (\n                                gen_random_uuid(),\n                                'state.deleted',\n                                'state',\n                                OLD.id,\n                                OLD.workspace_id,\n                                OLD.project_id,\n                                jsonb_build_object('data', '{}', 'previous_attributes', state_data),\n                                now(),\n                                NEW.updated_by_id,\n                                COALESCE(current_setting('plane.initiator_type', true), 'USER')\n                            )\n                            ON CONFLICT DO NOTHING;\n                        EXCEPTION\n                            WHEN others THEN\n                                RAISE WARNING 'Outbox delete failed for state %, reason: %',\n                                             OLD.id, SQLERRM;\n                        END;\n                    ELSE\n                        -- This is a regular update, check for changes\n                        FOR field_name IN\n                            SELECT column_name\n                            FROM information_schema.columns\n                            WHERE table_name = 'states'\n                            AND table_schema = 'public'\n                            AND column_name NOT IN ('updated_at', 'updated_by_id')\n                        LOOP\n                            -- Get old and new values as text to avoid JSON conversion issues\n                            EXECUTE format('SELECT ($1).%I::text, ($2).%I::text', field_name, field_name)\n                            INTO old_value, new_value\n                            USING OLD, NEW;\n\n                            -- If values are different, add to changes\n                            IF old_value IS DISTINCT FROM new_value THEN\n                                has_changes := true;\n                                changes := changes || jsonb_build_object(\n                                    field_name,\n                                    old_value\n                                );\n                            END IF;\n                        END LOOP;\n\n                        -- Only proceed if there are actual changes\n                        IF has_changes THEN\n                            state_data := to_jsonb(NEW);\n\n                            BEGIN\n                                INSERT INTO outbox (event_id, event_type, entity_type, entity_id, workspace_id, project_id, payload, created_at, initiator_id, initiator_type)\n                                VALUES (\n                                    gen_random_uuid(),\n                                    'state.updated',\n                                    'state',\n                                    NEW.id,\n                                    NEW.workspace_id,\n                                    NEW.project_id,\n                                    jsonb_build_object(\n                                        'data', state_data,\n                                        'previous_attributes', changes\n                                    ),\n                                    now(),\n                                    NEW.updated_by_id,\n                                    COALESCE(current_setting('plane.initiator_type', true), 'USER')\n                                )\n                                ON CONFLICT DO NOTHING;\n                            EXCEPTION\n                                WHEN others THEN\n                                    RAISE WARNING 'Outbox update failed for state %, reason: %',\n                                                 NEW.id, SQLERRM;\n                            END;\n                        END IF;\n                    END IF;\n\n                    RETURN NEW;\n                END;\n                ", hash='8193e42757f78c34bed7b2741158fcd9414935e5', operation='UPDATE', pgid='pgtrigger_state_outbox_update_358a1', table='states', when='AFTER')),
        ),
    ]
